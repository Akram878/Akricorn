<div class="course-viewer" *ngIf="!isLoading && course; else viewerState">
  <header class="course-viewer__masthead">
    <nav class="course-viewer__breadcrumbs">
      <a routerLink="/lms/my-courses" class="course-viewer__crumb">كورساتي</a>
      <span class="course-viewer__separator">›</span>
      <span class="course-viewer__crumb course-viewer__crumb--active">{{ course?.title }}</span>
    </nav>

    <div class="course-viewer__hero">
      <div
        class="course-viewer__cover"
        [class.course-viewer__cover--placeholder]="!course?.thumbnailUrl"
      >
        <ng-container *ngIf="course?.thumbnailUrl; else coverPlaceholder">
          <img [src]="course?.thumbnailUrl" [alt]="course?.title || 'صورة الكورس'" loading="lazy" />
        </ng-container>
        <ng-template #coverPlaceholder>
          <div class="course-viewer__cover-placeholder">لا توجد صورة</div>
        </ng-template>
        <span class="course-viewer__status" *ngIf="course?.completedAt">منجز</span>
      </div>
      <div class="course-viewer__hero-content">
        <p class="course-viewer__eyebrow">كورس مسجل</p>
        <h1 class="course-viewer__title">{{ course?.title }}</h1>
        <p class="course-viewer__description">{{ course?.description }}</p>

        <div class="course-viewer__meta">
          <div class="course-viewer__meta-item">
            <span class="course-viewer__meta-label">المدة</span>
            <strong>{{ course?.hours || 0 }} ساعة</strong>
          </div>
          <div class="course-viewer__meta-item">
            <span class="course-viewer__meta-label">التصنيف</span>
            <strong>{{ course?.category || 'غير محدد' }}</strong>
          </div>
          <div class="course-viewer__meta-item" *ngIf="course?.rating">
            <span class="course-viewer__meta-label">التقييم</span>
            <strong>⭐ {{ course?.rating | number : '1.1-1' }} / 5</strong>
          </div>
        </div>

        <div class="course-viewer__dates">
          <span *ngIf="course?.purchasedAt"
            >تم الشراء في {{ course?.purchasedAt | date : 'mediumDate' }}</span
          >
          <span *ngIf="course?.completedAt"
            >اكتمل في {{ course?.completedAt | date : 'mediumDate' }}</span
          >
        </div>

        <div class="course-viewer__actions">
          <button
            type="button"
            class="lms-primary-btn"
            [disabled]="isCompleting"
            (click)="finishCourse()"
          >
            {{ isCompleting ? 'جاري الإنهاء…' : 'إنهاء الكورس' }}
          </button>
          <button
            type="button"
            class="course-viewer__ghost"
            (click)="closeViewer()"
            *ngIf="selectedFile"
          >
            إغلاق المشغل
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="course-viewer__layout">
    <section
      class="course-viewer__panel course-viewer__panel--outline"
      *ngIf="hasSections; else emptySections"
    >
      <div class="course-viewer__panel-head">
        <div>
          <p class="course-viewer__eyebrow">المحتوى الدراسي</p>
          <h2>المحاضرات والملفات</h2>
        </div>
        <span class="course-viewer__count">{{ course?.sections?.length || 0 }} أقسام</span>
      </div>

      <div class="course-viewer__section" *ngFor="let section of course?.sections">
        <div class="course-viewer__section-head">
          <div>
            <p class="course-viewer__eyebrow">Section {{ section.order }}</p>
            <h3>{{ section.title }}</h3>
          </div>
          <span class="course-viewer__count">{{ section.lessons.length }} lessons</span>
        </div>

        <div class="course-viewer__lesson" *ngFor="let lesson of section.lessons">
          <div class="course-viewer__lesson-title">{{ lesson.title }}</div>
          <div class="course-viewer__files">
            <button
              type="button"
              class="course-viewer__file"
              *ngFor="let file of lesson.files"
              [class.course-viewer__file--active]="selectedFile?.id === file.id"
              (click)="selectFile(file, lesson.title, section.title)"
            >
              {{ file.name }}
            </button>
          </div>
        </div>
      </div>
    </section>
    <section class="course-viewer__panel course-viewer__panel--progress" *ngIf="hasLearningPaths">
      <div class="course-viewer__panel-head">
        <div>
          <p class="course-viewer__eyebrow">مسارات التعلم</p>
          <h2>تقدمك داخل المسارات</h2>
          <p class="course-viewer__note">يتم تحديث التقدم تلقائياً بعد إكمال الكورس.</p>
        </div>
      </div>

      <div class="course-viewer__path" *ngFor="let path of course?.learningPaths">
        <div class="course-viewer__path-head">
          <span class="course-viewer__path-title">{{ path.learningPathTitle }}</span>
          <span class="course-viewer__path-meta">{{ formatPathProgress(path) }}</span>
        </div>
        <div class="course-viewer__progress" aria-hidden="true">
          <span class="course-viewer__progress-bar" [style.width.%]="path.completionPercent"></span>
        </div>
      </div>
    </section>
  </div>

  <div class="course-viewer__overlay" *ngIf="selectedFile" aria-modal="true" role="dialog">
    <div class="course-viewer__overlay-shell" dir="rtl">
      <div class="course-viewer__overlay-top">
        <button type="button" class="course-viewer__back" (click)="closeViewer()" aria-label="رجوع">
          ←
        </button>
        <div class="course-viewer__overlay-meta">
          <p class="course-viewer__viewer-meta">
            {{ selectedFile?.sectionTitle }} • {{ selectedFile?.lessonTitle }}
          </p>
          <h3 class="course-viewer__viewer-title">{{ selectedFile?.name }}</h3>
        </div>
      </div>

      <div class="course-viewer__overlay-body">
        <div class="course-viewer__player" [ngSwitch]="selectedFile?.type">
          <div class="course-viewer__pdf" *ngSwitchCase="'pdf'">
            <div class="course-viewer__pdf-surface" #pdfContainer></div>
            <div class="course-viewer__pdf-state" *ngIf="isRenderingPdf && !pdfRenderError">
              جاري تحميل ملف PDF…
            </div>
            <div
              class="course-viewer__pdf-state course-viewer__pdf-state--error"
              *ngIf="pdfRenderError"
            >
              {{ pdfRenderError }}
            </div>
          </div>
          <video *ngSwitchCase="'video'" [src]="selectedFile?.safeUrl" controls playsinline></video>
          <audio *ngSwitchCase="'audio'" [src]="selectedFile?.safeUrl" controls></audio>
          <iframe
            *ngSwitchCase="'embed'"
            [src]="selectedFile?.safeUrl"
            title="Lesson resource"
          ></iframe>
          <img
            *ngSwitchCase="'image'"
            [src]="selectedFile?.displayUrl || selectedFile?.url"
            [alt]="selectedFile?.name"
          />
          <div class="course-viewer__download" *ngSwitchDefault>
            <p>لا يمكن عرض هذا الملف هنا، يمكنك تنزيله وفتحه.</p>
          </div>
        </div>
        <aside class="course-viewer__sidebar" aria-label="التنقل بين ملفات الكورس">
          <div class="course-viewer__sidebar-head">
            <p class="course-viewer__eyebrow">محتوى الكورس</p>
            <h4>{{ course?.title }}</h4>
          </div>

          <div class="course-viewer__sidebar-section" *ngFor="let section of course?.sections">
            <div class="course-viewer__sidebar-section-head">
              <div>
                <p class="course-viewer__eyebrow">Section {{ section.order }}</p>
                <h5>{{ section.title }}</h5>
              </div>
              <span class="course-viewer__count">{{ section.lessons.length }} دروس</span>
            </div>

            <div class="course-viewer__sidebar-lesson" *ngFor="let lesson of section.lessons">
              <div class="course-viewer__sidebar-lesson-title">{{ lesson.title }}</div>
              <div class="course-viewer__sidebar-files">
                <button
                  type="button"
                  class="course-viewer__file"
                  *ngFor="let file of lesson.files"
                  [class.course-viewer__file--active]="selectedFile?.id === file.id"
                  (click)="selectFile(file, lesson.title, section.title)"
                >
                  {{ file.name }}
                </button>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>

<ng-template #viewerState>
  <div class="course-viewer__state" *ngIf="isLoading">Loading course…</div>
  <div class="course-viewer__state course-viewer__state--error" *ngIf="!isLoading && error">
    {{ error }}
  </div>
</ng-template>

<ng-template #emptySections>
  <div class="course-viewer__panel course-viewer__panel--empty">
    <div class="course-viewer__empty">
      <h3>لا يوجد محتوى بعد لهذا الكورس</h3>
      <p>عند إضافة دروس وملفات ستظهر هنا بشكل منظم.</p>
    </div>
  </div>
</ng-template>
