<section class="lms-section course-viewer">
  <header class="lms-section__header">
    <div class="lms-section__breadcrumb">
      <a routerLink="/lms/my-courses">My Courses</a>
      <span>/</span>
      <span class="active">Course Viewer</span>
    </div>

    <p>Follow the course lessons and files from one place.</p>
  </header>

  <div class="lms-section__body">
    <div class="lms-section__state" *ngIf="isLoading">Loading course data...</div>
    <div class="lms-section__state lms-section__state--error" *ngIf="error">{{ error }}</div>

    <ng-container *ngIf="!isLoading && !error && course">
      <div class="course-viewer__hero">
        <div class="course-viewer__info">
          <div class="course-viewer__thumb" aria-hidden="true">
            <img
              *ngIf="courseThumbnailUrl"
              [src]="courseThumbnailUrl"
              [alt]="course.title"
              loading="lazy"
            />
            <div class="course-viewer__thumb-placeholder" *ngIf="!courseThumbnailUrl">
              <svg class="logo__icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 134 155">
                <defs>
                  <!-- Golden gradient -->
                  <linearGradient id="goldGradient1" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="50%" stop-color="#020f0c" />
                    <stop offset="100%" stop-color="#021813" />
                    <!-- <stop offset="75%" stop-color="#08342a" />
                    <stop offset="100%" stop-color="rgb(12.08, 78.52, 63.42)" /> -->
                  </linearGradient>

                  <!-- Soft shadow -->
                  <filter id="goldShadow" x="-10%" y="-10%" width="140%" height="140%">
                    <feDropShadow
                      dx="0"
                      dy="4"
                      stdDeviation="6"
                      flood-color="#000000"
                      flood-opacity="0.65"
                    />
                  </filter>
                </defs>

                <g fill="url(#goldGradient1)" stroke="" stroke-width="2" filter="">
                  <path
                    d="M70.3,114.4c-0.8,23,15.4,37,17.4,38.6c-2.6,0.1-18.5,0.8-30.9-11.6
         c-9.8-9.8-11.3-21.7-11.6-25.1c-0.1-1.8-0.7-19.2,13.5-30.9
         c13.3-10.9,28.8-8.1,30.9-7.7C87.4,79.3,71.1,91.9,70.3,114.4z"
                  />
                  <path
                    d="M132.4,52.5c-15.6-22.6-39.8-34.3-61.9-30c-3.9,0.8-21.4,5-31.9,20.6
         c-1.7,2.6-6.6,10.1-7.5,20.6c-0.6,7.1,0.8,12.9,1.9,16.9
         c2.7,10.2,5.9,12.3,7.5,18.8c1.3,5.5,1.4,14-5.6,26.3
         c-3.5-2.1-27.2-17-31.9-46.9c-3.7-24,6.4-47.7,24.4-61.9
         C51-1.9,85.2-1.9,108,15C125.2,27.6,130.7,45.7,132.4,52.5z"
                  />
                </g>
              </svg>
            </div>
          </div>

          <div class="course-viewer__info-header">
            <div class="titstat">
              <h3>{{ course.title }}</h3>
              <span class="course-viewer__badge" *ngIf="course.completedAt">Completed</span>
              <span
                class="course-viewer__badge course-viewer__badge--active"
                *ngIf="!course.completedAt"
              >
                In progress
              </span>
            </div>

            <p class="course-viewer__description">{{ course.description }}</p>
          </div>

          <div class="course-viewer__meta">
            <div class="course-viewer__meta-item" *ngIf="course.category">
              <span>Level</span>
              <strong>{{ course.category }}</strong>
            </div>
            <div
              class="course-viewer__meta-item"
              *ngIf="course.hours !== null && course.hours !== undefined"
            >
              <span>Duration</span>
              <strong>{{ course.hours }} hours</strong>
            </div>
            <div class="course-viewer__meta-item" *ngIf="course.pathTitle">
              <span>Path</span>
              <strong>{{ course.pathTitle }}</strong>
            </div>
            <div class="course-viewer__meta-item">
              <span>Sections</span>
              <strong>{{ course.sections?.length || 0 }}</strong>
            </div>
          </div>
        </div>
      </div>

      <div class="course-viewer__layout">
        <div class="course-viewer__content">
          <div class="course-viewer__sections" *ngIf="hasSections; else emptySections">
            <div
              class="course-viewer__section"
              *ngFor="let section of course.sections; let sIndex = index"
            >
              <div class="course-viewer__section-header">
                <div>
                  <span class="course-viewer__section-index">Section {{ sIndex + 1 }}</span>
                  <h3>{{ section.title }}</h3>
                </div>
                <span class="course-viewer__section-count">{{ section.lessons.length }} lessons</span>
              </div>

              <div class="course-viewer__lessons">
                <div
                  class="course-viewer__lesson"
                  *ngFor="let lesson of section.lessons; let lIndex = index"
                >
                  <div class="course-viewer__lesson-header">
                    <div class="course-viewer__lesson-title">
                      <span class="course-viewer__lesson-index">{{ lIndex + 1 }}</span>
                      <h4>{{ lesson.title }}</h4>
                    </div>
                    <div class="course-viewer__lesson-actions">
                      <span class="course-viewer__lesson-count"
                        >{{ lesson.files.length }} files</span
                      >
                      <span class="course-viewer__lesson-status" *ngIf="lesson.isCompleted">
                        Completed
                      </span>
                      <button
                        type="button"
                        class="course-viewer__lesson-action"
                        (click)="completeLesson(lesson.id)"
                        [disabled]="lesson.isCompleted || isLessonCompleting(lesson.id)"
                      >
                        {{ lesson.isCompleted ? 'Lesson completed' : 'Finish lesson' }}
                      </button>
                    </div>
                  </div>

                  <div
                    class="course-viewer__files"
                    *ngIf="lesson.files.length > 0; else emptyFiles"
                  >
                    <button
                      type="button"
                      class="course-viewer__file"
                      *ngFor="let file of lesson.files"
                      (click)="openLessonFile(file)"
                    >
                      <span class="course-viewer__file-name">{{ file.name }}</span>
                      <span class="course-viewer__file-action">View</span>
                    </button>
                  </div>

                  <ng-template #emptyFiles>
                    <div class="lms-section__state lms-section__state--empty">
                      There are no files for this lesson.
                    </div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>

          <ng-template #emptySections>
            <div class="lms-section__state lms-section__state--empty">
              No sections are available for this course.
            </div>
          </ng-template>
        </div>

        <aside class="course-viewer__progress">
          <div class="course-viewer__progress-card">
            <div class="course-viewer__progress-header">
              <h4>Course progress</h4>
              <span class="course-viewer__progress-value">{{ courseProgressPercent }}%</span>
            </div>
            <div class="course-viewer__progress-bar" role="progressbar">
              <span [style.width.%]="courseProgressPercent"></span>
            </div>
            <p class="course-viewer__progress-note">
              {{ completedLessonsCount }}/{{ totalLessonsCount }} completed lessons
              <span *ngIf="course?.completedAt">· The course was completed successfully.</span>
            </p>
          </div>

          <div class="course-viewer__progress-card">
            <div class="course-viewer__progress-header">
              <h4>Learning path progress</h4>
              <span class="course-viewer__progress-value">
                {{ hasLearningPaths ? 'Linked' : 'Not linked to a path' }}
              </span>
            </div>

            <ng-container *ngIf="hasLearningPaths; else noLearningPath">
              <div class="course-viewer__path-progress-list">
                <div
                  class="course-viewer__path-progress-item"
                  *ngFor="let path of course.learningPaths"
                >
                  <div class="course-viewer__path-progress-info">
                    <span>{{ path.learningPathTitle }}</span>
                    <strong>{{ path.completionPercent }}%</strong>
                  </div>
                  <div class="course-viewer__progress-bar">
                    <span [style.width.%]="path.completionPercent"></span>
                  </div>
                  <small>{{ formatPathProgress(path) }}</small>
                </div>
              </div>
            </ng-container>

            <ng-template #noLearningPath>
              <p class="course-viewer__progress-note">No learning path is linked to this course.</p>
            </ng-template>
          </div>

          <div class="course-viewer__progress-card course-viewer__rating-card">
            <div class="course-viewer__progress-header">
              <h4>Course rating</h4>
              <span class="course-viewer__progress-value">
                {{ course.rating ?? 0 | number : '1.1-1' }}/5
              </span>
            </div>
            <p class="course-viewer__progress-note">
              {{ course.ratingCount ?? 0 }} ratings
              <span *ngIf="course.userRating">· Your rating {{ course.userRating }}/5</span>
            </p>

            <div class="course-viewer__rating-stars">
              <button
                type="button"
                class="course-viewer__rating-star"
                *ngFor="let star of ratingStars"
                (click)="selectRating(star)"
                [class.is-selected]="star <= ratingValue"
                [disabled]="!canRateCourse"
              >
                ★
              </button>
            </div>

            <button
              type="button"
              class="course-viewer__rating-submit"
              (click)="submitRating()"
              [disabled]="!canRateCourse || isSubmittingRating"
            >
              {{ course.userRating ? 'Rating submitted' : 'Submit rating' }}
            </button>

            <p class="course-viewer__progress-note" *ngIf="!course.completedAt">
              Complete the course first to be able to rate it.
            </p>
          </div>
        </aside>
      </div>
    </ng-container>
  </div>
</section>
