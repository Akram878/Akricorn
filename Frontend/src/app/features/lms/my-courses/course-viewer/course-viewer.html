<section class="lms-section course-viewer">
  <header class="lms-section__header">
    <div class="lms-section__breadcrumb">
      <a routerLink="/lms/my-courses">ููุฑุณุงุชู</a>
      <span>/</span>
      <span class="active">ุนุงุฑุถ ุงูููุฑุณ</span>
    </div>
    <h2>{{ course?.title || 'ุชูุงุตูู ุงูููุฑุณ' }}</h2>
    <p>ุชุงุจุน ุงูุฏุฑูุณ ูุงููููุงุช ุงูุฎุงุตุฉ ุจุงูููุฑุณ ูู ููุงู ูุงุญุฏ.</p>
  </header>

  <div class="lms-section__body">
    <div class="lms-section__state" *ngIf="isLoading">ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงูููุฑุณ...</div>
    <div class="lms-section__state lms-section__state--error" *ngIf="error">{{ error }}</div>

    <ng-container *ngIf="!isLoading && !error && course">
      <div class="course-viewer__hero">
        <div class="course-viewer__thumb" aria-hidden="true">
          <img
            *ngIf="courseThumbnailUrl"
            [src]="courseThumbnailUrl"
            [alt]="course.title"
            loading="lazy"
          />
          <div class="course-viewer__thumb-placeholder" *ngIf="!courseThumbnailUrl">๐</div>
        </div>

        <div class="course-viewer__info">
          <div class="course-viewer__info-header">
            <div>
              <span class="course-viewer__badge" *ngIf="course.completedAt">ููุชูู</span>
              <span
                class="course-viewer__badge course-viewer__badge--active"
                *ngIf="!course.completedAt"
              >
                ููุฏ ุงูุฏุฑุงุณุฉ
              </span>
              <h3>{{ course.title }}</h3>
            </div>
          </div>

          <p class="course-viewer__description">{{ course.description }}</p>

          <div class="course-viewer__meta">
            <div class="course-viewer__meta-item" *ngIf="course.category">
              <span>ุงููุณุชูู</span>
              <strong>{{ course.category }}</strong>
            </div>
            <div
              class="course-viewer__meta-item"
              *ngIf="course.hours !== null && course.hours !== undefined"
            >
              <span>ุงููุฏุฉ</span>
              <strong>{{ course.hours }} ุณุงุนุฉ</strong>
            </div>
            <div class="course-viewer__meta-item" *ngIf="course.pathTitle">
              <span>ุงููุณุงุฑ</span>
              <strong>{{ course.pathTitle }}</strong>
            </div>
            <div class="course-viewer__meta-item">
              <span>ุงูุฃูุณุงู</span>
              <strong>{{ course.sections?.length || 0 }}</strong>
            </div>
          </div>

          <div class="course-viewer__paths" *ngIf="hasLearningPaths">
            <h4>ุชูุฏู ุงููุณุงุฑุงุช</h4>
            <div class="course-viewer__path" *ngFor="let path of course.learningPaths">
              <span>{{ path.learningPathTitle }}</span>
              <span class="course-viewer__path-progress">{{ formatPathProgress(path) }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="course-viewer__layout">
        <div class="course-viewer__content">
          <div class="course-viewer__sections" *ngIf="hasSections; else emptySections">
            <div
              class="course-viewer__section"
              *ngFor="let section of course.sections; let sIndex = index"
            >
              <div class="course-viewer__section-header">
                <div>
                  <span class="course-viewer__section-index">ูุณู {{ sIndex + 1 }}</span>
                  <h3>{{ section.title }}</h3>
                </div>
                <span class="course-viewer__section-count">{{ section.lessons.length }} ุฏุฑูุณ</span>
              </div>

              <div class="course-viewer__lessons">
                <div
                  class="course-viewer__lesson"
                  *ngFor="let lesson of section.lessons; let lIndex = index"
                >
                  <div class="course-viewer__lesson-header">
                    <div class="course-viewer__lesson-title">
                      <span class="course-viewer__lesson-index">{{ lIndex + 1 }}</span>
                      <h4>{{ lesson.title }}</h4>
                    </div>
                    <div class="course-viewer__lesson-actions">
                      <span class="course-viewer__lesson-count"
                        >{{ lesson.files.length }} ูููุงุช</span
                      >
                      <span class="course-viewer__lesson-status" *ngIf="lesson.isCompleted">
                        ููุชูู
                      </span>
                      <button
                        type="button"
                        class="course-viewer__lesson-action"
                        (click)="completeLesson(lesson.id)"
                        [disabled]="lesson.isCompleted || isLessonCompleting(lesson.id)"
                      >
                        {{ lesson.isCompleted ? 'ุชู ุฅููุงุก ุงูุฏุฑุณ' : 'ุฅููุงุก ุงูุฏุฑุณ' }}
                      </button>
                    </div>
                  </div>

                  <div
                    class="course-viewer__files"
                    *ngIf="lesson.files.length > 0; else emptyFiles"
                  >
                    <button
                      type="button"
                      class="course-viewer__file"
                      *ngFor="let file of lesson.files"
                      (click)="selectFile(file, lesson.title, section.title)"
                      [class.is-active]="selectedFile?.id === file.id"
                    >
                      <span class="course-viewer__file-name">{{ file.name }}</span>
                      <span class="course-viewer__file-action">ุนุฑุถ</span>
                    </button>
                  </div>

                  <ng-template #emptyFiles>
                    <div class="lms-section__state lms-section__state--empty">
                      ูุง ุชูุฌุฏ ูููุงุช ููุฐุง ุงูุฏุฑุณ.
                    </div>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>

          <ng-template #emptySections>
            <div class="lms-section__state lms-section__state--empty">
              ูุง ุชูุฌุฏ ุฃูุณุงู ูุชุงุญุฉ ููุฐุง ุงูููุฑุณ.
            </div>
          </ng-template>
        </div>

        <aside class="course-viewer__progress">
          <div class="course-viewer__progress-card">
            <div class="course-viewer__progress-header">
              <h4>ุชูุฏู ุงูููุฑุณ</h4>
              <span class="course-viewer__progress-value">{{ courseProgressPercent }}%</span>
            </div>
            <div class="course-viewer__progress-bar" role="progressbar">
              <span [style.width.%]="courseProgressPercent"></span>
            </div>
            <p class="course-viewer__progress-note">
              {{ completedLessonsCount }}/{{ totalLessonsCount }} ุฏุฑูุณ ููุชููุฉ
              <span *ngIf="course?.completedAt">ยท ุชู ุฅููุงุก ุงูููุฑุณ ุจูุฌุงุญ.</span>
            </p>
          </div>

          <div class="course-viewer__progress-card">
            <div class="course-viewer__progress-header">
              <h4>ุชูุฏู ุงููุณุงุฑ ุงูุชุนูููู</h4>
              <span class="course-viewer__progress-value">
                {{ hasLearningPaths ? 'ูุชุงุจุน' : 'ุบูุฑ ูุชุตู ุจูุณุงุฑ' }}
              </span>
            </div>

            <ng-container *ngIf="hasLearningPaths; else noLearningPath">
              <div class="course-viewer__path-progress-list">
                <div
                  class="course-viewer__path-progress-item"
                  *ngFor="let path of course.learningPaths"
                >
                  <div class="course-viewer__path-progress-info">
                    <span>{{ path.learningPathTitle }}</span>
                    <strong>{{ path.completionPercent }}%</strong>
                  </div>
                  <div class="course-viewer__progress-bar">
                    <span [style.width.%]="path.completionPercent"></span>
                  </div>
                  <small>{{ formatPathProgress(path) }}</small>
                </div>
              </div>
            </ng-container>

            <ng-template #noLearningPath>
              <p class="course-viewer__progress-note">ูุง ููุฌุฏ ูุณุงุฑ ูุฑุชุจุท ุจูุฐุง ุงูููุฑุณ.</p>
            </ng-template>
          </div>
        </aside>
      </div>

      <section class="course-viewer__file-panel" *ngIf="selectedFile">
        <div class="course-viewer__file-panel-header">
          <div>
            <span class="course-viewer__viewer-title">ุนุงุฑุถ ุงููููุงุช</span>
            <p>{{ selectedFile.sectionTitle }} ยท {{ selectedFile.lessonTitle }}</p>
          </div>
          <div class="course-viewer__file-panel-actions">
            <button type="button" class="course-viewer__toggle" (click)="toggleSidebar()">
              {{ isSidebarOpen ? 'ุฅุฎูุงุก ุงููุงุฆูุฉ' : 'ุฅุธูุงุฑ ุงููุงุฆูุฉ' }}
            </button>
            <button type="button" class="course-viewer__close" (click)="closeViewer()">
              ุฅุบูุงู
            </button>
          </div>
        </div>

        <div class="course-viewer__file-panel-body" [class.is-collapsed]="!isSidebarOpen">
          <aside class="course-viewer__file-sidebar">
            <h4>ูููุงุช ุงูููุฑุณ</h4>
            <ng-container *ngIf="hasSections; else emptySidebarFiles">
              <div
                class="course-viewer__file-sidebar-section"
                *ngFor="let section of course.sections"
              >
                <strong>{{ section.title }}</strong>
                <div class="course-viewer__file-sidebar-lessons">
                  <div
                    class="course-viewer__file-sidebar-lesson"
                    *ngFor="let lesson of section.lessons"
                  >
                    <span>{{ lesson.title }}</span>
                    <div class="course-viewer__file-sidebar-files">
                      <button
                        type="button"
                        class="course-viewer__file-sidebar-file"
                        *ngFor="let file of lesson.files"
                        (click)="selectFile(file, lesson.title, section.title)"
                        [class.is-active]="selectedFile?.id === file.id"
                      >
                        {{ file.name }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
            <ng-template #emptySidebarFiles>
              <div class="lms-section__state lms-section__state--empty">ูุง ุชูุฌุฏ ูููุงุช.</div>
            </ng-template>
          </aside>

          <div class="course-viewer__file-panel-viewer">
            <div class="course-viewer__viewer-file">
              <div class="course-viewer__viewer-label">
                <span>{{ selectedFile.name }}</span>
                <a [href]="selectedFile.url" target="_blank" rel="noopener">ุชุญููู ุงูููู</a>
              </div>

              <div class="course-viewer__viewer-content">
                <div class="lms-section__state" *ngIf="isMediaLoading">ุฌุงุฑู ุชุญููู ุงูููู...</div>

                <ng-container [ngSwitch]="selectedFile.type">
                  <video *ngSwitchCase="'video'" [src]="selectedFile.displayUrl" controls></video>
                  <audio *ngSwitchCase="'audio'" [src]="selectedFile.displayUrl" controls></audio>
                  <img
                    *ngSwitchCase="'image'"
                    [src]="selectedFile.displayUrl"
                    [alt]="selectedFile.name"
                  />
                  <iframe
                    *ngSwitchCase="'pdf'"
                    [src]="selectedFile.safeUrl"
                    title="PDF Viewer"
                  ></iframe>
                  <iframe
                    *ngSwitchCase="'embed'"
                    [src]="selectedFile.safeUrl"
                    title="Embedded Content"
                  ></iframe>
                  <div *ngSwitchCase="'download'" class="course-viewer__download">
                    ูุฐุง ุงูููุน ูู ุงููููุงุช ูุชุทูุจ ุงูุชุญููู.
                    <a [href]="selectedFile.url" target="_blank" rel="noopener">ุชุญููู ุงูููู</a>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>
      </section>
    </ng-container>
  </div>
</section>
